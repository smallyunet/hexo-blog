<!-- Stable asset version (for cache busting without full-site churn)--><!DOCTYPE html><html lang="zh-cn"><head><title>DeFi 进阶: 闪电贷与套利</title><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><!-- SEO basics--><meta name="description"><!-- Open Graph & Twitter--><link rel="canonical" href="https://crazy.smallyu.net/2025/08/21/DeFi进阶1/"><meta property="og:title" content="DeFi 进阶: 闪电贷与套利"><meta property="og:type" content="article"><meta property="og:url" content="https://crazy.smallyu.net/2025/08/21/DeFi进阶1/"><meta property="og:site_name" content="smallyu的博客（疯狂版）"><meta name="twitter:card" content="summary_large_image"><!-- Browser UI color--><meta name="theme-color" media="(prefers-color-scheme: light)" content="#ffffff"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#0f1115"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="manifest" href="/site.webmanifest"><!-- stylesheets--><!-- Use a stable, configurable asset version to prevent full-site churn on every build.--><!-- Set `asset_version` in theme _config.yml when you actually change CSS/JS.--><link rel="stylesheet" href="/css/xcode.min.css?v=2025-10-13"><link rel="stylesheet" href="/css/post.css?v=2025-10-13"><!-- unified typography overrides for both home and post pages--><link rel="stylesheet" href="/css/typography.css?v=2025-10-13"><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="smallyu的博客（疯狂版）" type="application/atom+xml">
</head><body><div><div class="inner"><h1>DeFi 进阶: 闪电贷与套利</h1><div class="time">2025-08-21</div><div class="title-margin"></div><blockquote>
<p>这是一个 DeFi 系列教程，在动手实践的过程中，学习和理解 DeFi 相关的概念与原理：</p>
<ol>
<li><a href="/2025/08/20/DeFi%E5%9F%BA%E7%A1%801/">DeFi 基础: 理解 AMM 定价机制</a></li>
<li><a href="/2025/08/21/DeFi%E5%9F%BA%E7%A1%802/">DeFi 基础: 预言机与报价</a></li>
<li><a href="/2025/08/21/DeFi%E5%9F%BA%E7%A1%803/">DeFi 基础: 借贷与清算</a></li>
<li><a href="/2025/08/21/DeFi%E8%BF%9B%E9%98%B61/">DeFi 进阶: 闪电贷与套利</a></li>
</ol>
</blockquote>
<p>闪电贷套利是我们经常听到的一个词，在实际的场景中有很多种模式。基于我们之前的 AMM 合约，就足以让我们来模拟一个简单版本的闪电贷套利。</p>
<h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>闪电贷的核心逻辑是，利用区块链智能合约的特性，在一笔交易内，借来大额资产（放大收益），拿着大额资产去执行别的操作，干什么都行，干完事情之后，再把借来的资金+少量手续费，原封不动还回去。因为智能合约是可以 revert 的，如果套利合约在执行过程中，发现最后套利没成功，可以回滚整个交易，除了手续费，没有额外损失。</p>
<p>我们接下来要模拟的场景时，有两个 AMM 池子，第一个池子的价格是 2000 USDC&#x2F;WETH，第二个池子的价格是 4000 USDC&#x2F;WETH。面对这样的场景，可以先想一下，不用闪电贷的情况下，应该如何套利。套利合约只不过是把我们的操作自动化了。</p>
<p>很简单，在第一个池子化 2000 USDC 买 1 个 WETH，到第二个池子上，直接就能卖出 4000 USDC，净赚 2000 USDC。</p>
<h3 id="合约说明"><a href="#合约说明" class="headerlink" title="合约说明"></a>合约说明</h3><p>我们会用到两个合约 <a href="https://github.com/smallyunet/defi-invariant-lab/blob/v0.0.4/contracts/flash/FlashLender.sol">FlashLender.sol</a> 和 <a href="https://github.com/smallyunet/defi-invariant-lab/blob/v0.0.4/contracts/flash/FlashArbBorrower.sol">FlashArbBorrower.sol</a>。这两个合约代表两个角色，其中 borrower 就是套利合约，会从 lender 那里借出一些资金。</p>
<p>也就是说 lender 合约，是有 <a href="https://github.com/smallyunet/defi-invariant-lab/blob/v0.0.4/contracts/flash/FlashLender.sol#L31-L35">借出资产功能</a> 的：</p>
<pre><code class="solidity">// 借出资产
require(t.transfer(receiver, amount), &quot;transfer out&quot;);

// 调用 borrower 的回调函数
bytes32 magic = IFlashBorrower(receiver).onFlashLoan(token, amount, fee, data);
require(magic == keccak256(&quot;IFlashBorrower.onFlashLoan&quot;), &quot;bad callback&quot;);

// 验证在回调函数后，borrower 是否归还了本金+手续费
uint256 balAfter = t.balanceOf(address(this));
require(balAfter &gt;= balBefore + fee, &quot;not repaid&quot;);
</code></pre>
<p>关键就是这 3 行，先借出钱，然后回调，最后判断 borrower 是否还款。</p>
<p>在 borrower 的回调函数里，会写一些具体的 <a href="https://github.com/smallyunet/defi-invariant-lab/blob/v0.0.4/contracts/flash/FlashArbBorrower.sol#L64C1-L71C38">套利逻辑</a>，比如从第一个池子买入 WETH，然后再卖到第二个池子：</p>
<pre><code class="solidity">// 从便宜的池子中买 WETH
uint256 wethOut = poolCheap.swap0For1(amount);

// 到贵的池子中卖 WETH
uint256 usdcBack = poolExpensive.swap1For0(wethOut);

// 还款给 lender
uint256 repay = amount + fee;
</code></pre>
<p>lender 和 borrower 是两个角色，那为什么不把这些逻辑写在一个合约里呢？如果写在一个合约里，意味着只有一个套利合约的角色，自己借钱出去、自己用钱套利，我自己都有钱了还借钱干嘛？</p>
<h3 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h3><p>合约代码源文件在仓库：<a href="https://github.com/smallyunet/defi-invariant-lab/tree/v0.0.4">smallyunet&#x2F;defi-invariant-lab@v0.0.4</a></p>
<p>克隆仓库：</p>
<pre><code class="bash">git clone https://github.com/smallyunet/defi-invariant-lab/
git switch v0.0.4
cd defi-invariant-lab
</code></pre>
<h3 id="部署第二个-AMM-合约"><a href="#部署第二个-AMM-合约" class="headerlink" title="部署第二个 AMM 合约"></a>部署第二个 AMM 合约</h3><p>部署合约：</p>
<pre><code class="bash">forge create \
  --rpc-url $RPC_URL \
  --private-key $PK_HEX \
  --broadcast \
  contracts/amm/SimpleAMM.sol:SimpleAMM \
  --constructor-args $USDC_ADDR $WETH_ADDR 30
</code></pre>
<p>部署后的合约地址：<a href="https://sepolia.etherscan.io/address/0xd9c870Ac0a84C3244286d39d870642d218b26532"><code>0xd9c870Ac0a84C3244286d39d870642d218b26532</code></a></p>
<h3 id="注入初始流动性"><a href="#注入初始流动性" class="headerlink" title="注入初始流动性"></a>注入初始流动性</h3><p>这个 AMM_B 池子我们认为是价格比较高的池子，所以按照 4000 USDC&#x2F;WETH 的价格注入初始流动性：</p>
<pre><code class="bash">export AMM_B=0xd9c870Ac0a84C3244286d39d870642d218b26532

cast send $USDC_ADDR &quot;approve(address,uint256)&quot; $AMM_B \
  0xffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff \
  --rpc-url $RPC_URL --private-key $PK_HEX

cast send $WETH_ADDR &quot;approve(address,uint256)&quot; $AMM_B \
  0xffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff \
  --rpc-url $RPC_URL --private-key $PK_HEX

cast send $AMM_B    &quot;addLiquidity(uint256,uint256)&quot; 4000000000000 1000000000000000000000 \
  --rpc-url $RPC_URL --private-key $PK_HEX
</code></pre>
<h3 id="部署-lender-并注资"><a href="#部署-lender-并注资" class="headerlink" title="部署 lender 并注资"></a>部署 lender 并注资</h3><p>部署合约：</p>
<pre><code class="bash">forge create \
  --rpc-url $RPC_URL \
  --private-key $PK_HEX \
  --broadcast \
  contracts/flash/FlashLender.sol:FlashLender \
  --constructor-args 5
</code></pre>
<p>部署后的合约是：<a href="https://sepolia.etherscan.io/address/0x3c00AB1eD5dF40f7ae8c1E4104C89445615B9D0a"><code>0x3c00AB1eD5dF40f7ae8c1E4104C89445615B9D0a</code></a></p>
<p>验证合约：</p>
<pre><code class="bash">forge verify-contract \
  --chain-id 11155111 \
  0x3c00AB1eD5dF40f7ae8c1E4104C89445615B9D0a \
  contracts/flash/FlashLender.sol:FlashLender \
  --constructor-args $(cast abi-encode &quot;constructor(uint16)&quot; 5) \
  --etherscan-api-key $ETHERSCAN_API_KEY
</code></pre>
<p>给 lender 转 20 万 USDC 作为初始资金：</p>
<pre><code class="bash">export LENDER=0x3c00AB1eD5dF40f7ae8c1E4104C89445615B9D0a

cast send $USDC_ADDR &quot;approve(address,uint256)&quot; $LENDER \
  0xffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff \
  --rpc-url $RPC_URL --private-key $PK_HEX

cast send $LENDER &quot;fund(address,uint256)&quot; $USDC_ADDR 200000000000 \
  --rpc-url $RPC_URL --private-key $PK_HEX
</code></pre>
<h3 id="部署套利合约"><a href="#部署套利合约" class="headerlink" title="部署套利合约"></a>部署套利合约</h3><p>部署合约：</p>
<pre><code class="bash">forge create \
  --rpc-url $RPC_URL \
  --private-key $PK_HEX \
  --broadcast \
  contracts/flash/FlashArbBorrower.sol:FlashArbBorrower \
  --constructor-args $LENDER $USDC_ADDR $WETH_ADDR $AMM_ADDR $AMM_B
</code></pre>
<p>部署的合约地址是：<a href="https://sepolia.etherscan.io/address/0x62363Fe02b83b804fd65FE3b862383631fEffb49"><code>0x62363Fe02b83b804fd65FE3b862383631fEffb49</code></a></p>
<p>验证合约：</p>
<pre><code class="bash">forge verify-contract \
  --chain-id 11155111 \
  0x62363Fe02b83b804fd65FE3b862383631fEffb49 \
  contracts/flash/FlashArbBorrower.sol:FlashArbBorrower \
  --constructor-args $(cast abi-encode &quot;constructor(address,address,address,address)&quot; $LENDER $USDC_ADDR $WETH_ADDR $AMM_ADDR $AMM_B) \
  --etherscan-api-key $ETHERSCAN_API_KEY
</code></pre>
<h3 id="执行一次闪电贷套利"><a href="#执行一次闪电贷套利" class="headerlink" title="执行一次闪电贷套利"></a>执行一次闪电贷套利</h3><p>直接调用 execute 函数：</p>
<pre><code class="bash">export ARB=0x62363Fe02b83b804fd65FE3b862383631fEffb49

cast send $ARB &quot;execute(uint256)&quot; 10000000000 \
  --rpc-url $RPC_URL --private-key $PK_HEX
</code></pre>
<p>我发起的交易哈希是：<a href="https://sepolia.etherscan.io/tx/0x948edfb7eeb5ceb924c1eb39704efd952f1cd3ed435c059a548dd7ea82031f15"><code>0x948edfb7eeb5ceb924c1eb39704efd952f1cd3ed435c059a548dd7ea82031f15</code></a></p>
<p>浏览器的交易过程比较直观，直接看浏览器的记录就好了：</p>
<img src="1.png" width="100%">

<p>可以看到在第一个池子里，用 10000 USDC 买了 4.6 个 WETH，紧接着把 WETH 卖掉，换出了 18000 USDC，净赚 8000 USDC。</p>
<p>borrower 的合约里有写把收益金额 <a href="https://github.com/smallyunet/defi-invariant-lab/blob/v0.0.4/contracts/flash/FlashArbBorrower.sol#L76-L80">emit 为事件</a>：</p>
<pre><code class="solidity">uint256 profit = usdcBack - repay;
if (profit &gt; 0) &#123;
    require(usdc.transfer(owner, profit), &quot;payout fail&quot;);
    emit Profit(profit);
&#125;
</code></pre>
<p>所以在浏览器上也能看到真的 <a href="https://sepolia.etherscan.io/tx/0x948edfb7eeb5ceb924c1eb39704efd952f1cd3ed435c059a548dd7ea82031f15#eventlog">触发了事件</a>：</p>
<img src="2.png" width="80%">



</div></div></body><!-- Defer non-critical scripts for better performance--><script defer src="/js/jquery.min.js?v=2025-10-13"></script><script defer src="/js/highlight.min.js?v=2025-10-13"></script><script defer src="/js/main.js?v=2025-10-13"></script><script defer src="/js/lightbox.js?v=2025-10-13"></script><script defer src="/js/bootstrap.min.js?v=2025-10-13"></script><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-5JRBZ6P1W3"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-5JRBZ6P1W3');</script></html>
<!-- Stable asset version (for cache busting without full-site churn)--><!DOCTYPE html><html lang="zh-cn"><head><title>DeFi 基础: 预言机与报价</title><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><!-- SEO basics--><meta name="description"><!-- Open Graph & Twitter--><link rel="canonical" href="https://crazy.smallyu.net/2025/08/21/DeFi基础2/"><meta property="og:title" content="DeFi 基础: 预言机与报价"><meta property="og:type" content="article"><meta property="og:url" content="https://crazy.smallyu.net/2025/08/21/DeFi基础2/"><meta property="og:site_name" content="smallyu的博客（疯狂版）"><meta name="twitter:card" content="summary_large_image"><!-- Browser UI color--><meta name="theme-color" media="(prefers-color-scheme: light)" content="#ffffff"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#0f1115"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="manifest" href="/site.webmanifest"><!-- stylesheets--><!-- Use a stable, configurable asset version to prevent full-site churn on every build.--><!-- Set `asset_version` in theme _config.yml when you actually change CSS/JS.--><link rel="stylesheet" href="/css/xcode.min.css?v=2025-09-29.3"><link rel="stylesheet" href="/css/post.css?v=2025-09-29.3"><!-- unified typography overrides for both home and post pages--><link rel="stylesheet" href="/css/typography.css?v=2025-09-29.3"><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="smallyu的博客（疯狂版）" type="application/atom+xml">
</head><body><div><div class="inner"><h1>DeFi 基础: 预言机与报价</h1><div class="time">2025-08-21</div><div class="title-margin"></div><blockquote>
<p>这是一个 DeFi 系列教程，在动手实践的过程中，学习和理解 DeFi 相关的概念与原理：</p>
<ol>
<li><a href="/2025/08/20/DeFi%E5%9F%BA%E7%A1%801/">DeFi 基础: 理解 AMM 定价机制</a></li>
<li><a href="/2025/08/21/DeFi%E5%9F%BA%E7%A1%802/">DeFi 基础: 预言机与报价</a></li>
<li><a href="/2025/08/21/DeFi%E5%9F%BA%E7%A1%803/">DeFi 基础: 借贷与清算</a></li>
<li><a href="/2025/08/21/DeFi%E8%BF%9B%E9%98%B61/">DeFi 进阶: 闪电贷与套利</a></li>
</ol>
</blockquote>
<p>预言机（Oracle）的逻辑相对简单，基本功能是，会有链下服务定时向链上提交一些数据，比如 WETH 的价格，合约保存下数据后，就可以被其他智能合约调用，直接获取到价格信息。</p>
<p>那么链下服务的价格信息，从哪里来？简单处理的话，可以来自 AMM 合约的初始流动性的定价。</p>
<p>以下所有操作都在 Sepolia 测试网进行。这些操作步骤，其实都是一些普通的合约交互步骤。主要是在操作过程中，进一步体会和理解合约的代码功能。</p>
<h3 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h3><p>合约代码源文件在仓库：<a href="https://github.com/smallyunet/defi-invariant-lab/tree/v0.0.2">smallyunet&#x2F;defi-invariant-lab@v0.0.2</a></p>
<p>Oracle 使用的合约是 <a href="https://github.com/smallyunet/defi-invariant-lab/blob/v0.0.2/contracts/oracle/MedianOracle.sol">MedianOracle.sol</a>，先克隆仓库：</p>
<pre><code class="bash">git clone https://github.com/smallyunet/defi-invariant-lab/
git switch v0.0.2
cd defi-invariant-lab
</code></pre>
<p>部署合约：</p>
<pre><code class="bash">forge create \
  --rpc-url $RPC_URL \
  --private-key $PK_HEX \
  --broadcast \
  contracts/oracle/MedianOracle.sol:MedianOracle
</code></pre>
<p>部署的合约地址是 <a href="https://sepolia.etherscan.io/address/0xdE342a228A2A83b47cA4eB3D3852578837E60750"><code>0xdE342a228A2A83b47cA4eB3D3852578837E60750</code></a>。</p>
<p>验证合约：</p>
<pre><code class="bash">forge verify-contract \
  --chain-id 11155111 \
  0xdE342a228A2A83b47cA4eB3D3852578837E60750 \
  contracts/oracle/MedianOracle.sol:MedianOracle \
  --etherscan-api-key $ETHERSCAN_API_KEY
</code></pre>
<h3 id="设置喂价人"><a href="#设置喂价人" class="headerlink" title="设置喂价人"></a>设置喂价人</h3><p>调用合约的 <a href="https://github.com/smallyunet/defi-invariant-lab/blob/v0.0.2/contracts/oracle/MedianOracle.sol#L14"><code>setFeeder</code></a> 函数，设定谁可以向 Oracle 提交数据：</p>
<pre><code class="bash">export ORACLE_ADDR=0xdE342a228A2A83b47cA4eB3D3852578837E60750

cast send $ORACLE_ADDR &quot;setFeeder(address,bool)&quot; \
  0x44D7A0F44e6340E666ddaE70dF6eEa9b5b17a657 true \
  --rpc-url $RPC_URL --private-key $PK_HEX
</code></pre>
<p>然后能查询到设置结果：</p>
<pre><code class="bash">cast call $ORACLE_ADDR &quot;feeders(address)((bool))&quot; $MY_ADDR --rpc-url $RPC_URL

# (true)
</code></pre>
<h3 id="首次喂价"><a href="#首次喂价" class="headerlink" title="首次喂价"></a>首次喂价</h3><p>发起交易：</p>
<pre><code class="bash">cast send $ORACLE_ADDR &quot;post(uint256[])&quot; \
  &quot;[199900000000,200000000000,200000000000,200000000000,200100000000]&quot; \
  --rpc-url $RPC_URL --private-key $PK_HEX
</code></pre>
<h3 id="读取最新价格"><a href="#读取最新价格" class="headerlink" title="读取最新价格"></a>读取最新价格</h3><p>读取价格：</p>
<pre><code class="bash">cast call $ORACLE_ADDR &quot;latest()(uint256,uint256)&quot; --rpc-url $RPC_URL
</code></pre>
</div></div></body><!-- Defer non-critical scripts for better performance--><script defer src="/js/jquery.min.js?v=2025-09-29.3"></script><script defer src="/js/highlight.min.js?v=2025-09-29.3"></script><script defer src="/js/main.js?v=2025-09-29.3"></script><script defer src="/js/lightbox.js?v=2025-09-29.3"></script><script defer src="/js/bootstrap.min.js?v=2025-09-29.3"></script><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-5JRBZ6P1W3"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-5JRBZ6P1W3');</script></html>
<!DOCTYPE html><html lang="zh-cn"><head><title>DeFi 基础: 理解 AMM 定价机制</title><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=0.5"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="manifest" href="/site.webmanifest"><link rel="stylesheet" href="/css/highlight/xcode.min.css"><link rel="stylesheet" href="/css/bootstrap/bootstrap-tooltips.css"><link rel="stylesheet" href="/css/post.css"><script src="/js/jquery.min.js"></script><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="smallyu的博客（疯狂版）" type="application/atom+xml">
</head><body><script>if (/mobile/i.test(navigator.userAgent) || /android/i.test(navigator.userAgent)) {
  document.body.classList.add('mobile')
  var navbar = document.querySelector('nav.navbar');
  if (navbar) {
    navbar.classList.remove('navbar-fixed-top');
  }
}
</script><div><div class="inner"><h1>DeFi 基础: 理解 AMM 定价机制</h1><div class="time">2025-08-20</div><ul class="tags"><li><span>#</span><a href="/tags/DeFi/">DeFi</a></li></ul><blockquote>
<p>这是一个 DeFi 系列教程，在动手实践的过程中，学习和理解 DeFi 相关的概念与原理：</p>
<ol>
<li><a href="/2025/08/20/DeFi%E5%9F%BA%E7%A1%801/">DeFi 基础: 理解 AMM 定价机制</a></li>
<li><a href="/2025/08/21/DeFi%E5%9F%BA%E7%A1%802/">DeFi 基础: 预言机与报价</a></li>
<li><a href="/2025/08/21/DeFi%E5%9F%BA%E7%A1%803/">DeFi 基础: 借贷与清算</a></li>
<li><a href="/2025/08/21/DeFi%E8%BF%9B%E9%98%B61/">DeFi 进阶: 闪电贷与套利</a></li>
</ol>
</blockquote>
<p>AMM 的全称是 Automated Market Maker，自动做市商，作用是不需要订单簿撮合交易，就可以自动完成定价与交易。</p>
<p>这篇文章解释了 Uniswap V2 的核心定价逻辑，并且提供了完整的合约代码示例、命令行操作步骤、实际的链上交易现场等，作为理解 AMM 的配套参考。</p>
<h3 id="AMM-计算公式"><a href="#AMM-计算公式" class="headerlink" title="AMM 计算公式"></a>AMM 计算公式</h3><p>Uniswap V2 用的定价逻辑是恒定乘积做市商（Constant Product Market Maker, CPMM），也是我们的示例 AMM 合约在用的方法。这里有一个恒等公式：</p>
<pre><code>x * y = k
</code></pre>
<p>意味着池子里有两种资产 <code>x</code> 和 <code>y</code>，当 x 增多的时候，y 就应该减少，y 增多的时候，x 应该减少，k 总是保持不变。</p>
<p>在添加初始流动性的时候，我们第一次确定下来这个 k 的值，比如我们按照 2000 USDC &#x2F; 1 WETH 的价格注入初始流动性，会得到（不考虑精度）：</p>
<pre><code>k = 2000
</code></pre>
<p>当我们想要用 USDC 换出 WETH 的时候，池子里的 USDC 增多，为了保持 k 不变，合约就会把相应数量的 WETH 转给我们了。</p>
<p>这就是自动做市商的核心逻辑，价格不是写死的，而是根据池子中剩余的流动性算出来的。要注意 x 和 y 的乘积是一条曲线，因为 y&#x3D;k&#x2F;x，画成图是这样：</p>
<img src="1.png" width="50%">

<p>接下来会用实际的操作步骤与链上交互，来体验 AMM 的运作。</p>
<h3 id="示例合约"><a href="#示例合约" class="headerlink" title="示例合约"></a>示例合约</h3><p>合约代码源文件在仓库：<a href="https://github.com/smallyunet/defi-invariant-lab/tree/v0.0.1">smallyunet&#x2F;defi-invariant-lab@v0.0.1</a></p>
<p>首先准备两个合约，一个是 <a href="https://github.com/smallyunet/defi-invariant-lab/blob/v0.0.1/contracts/libs/TestERC20.sol">TestERC20.sol</a>，比起标准的 ERC-20 合约，支持自定义代币精度，以及随意 mint 一些代币。</p>
<p>第二个要准备的合约是 <a href="https://github.com/smallyunet/defi-invariant-lab/blob/v0.0.1/contracts/amm/SimpleAMM.sol">SimpleAMM.sol</a>，提供了对代币增加流动性、代币兑换等功能。合约代码不算很简单，我们会在接下来实际的操作用，逐步体会和理解这个合约的功能，以及解读源代码。</p>
<p>以下所有操作都在以太坊的测试网 Sepolia 上进行。</p>
<h3 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h3><p>准备好命令行工具，以及设置两个环境变量：</p>
<pre><code class="bash">foundryup

export RPC_URL=&quot;https://ethereum-sepolia-rpc.publicnode.com&quot;
export PK_HEX=&quot;&lt;YOUR_PRIVATE_KEY_HEX&gt;&quot;
</code></pre>
<p>下载合约仓库、进入到仓库根目录：</p>
<pre><code>git clone https://github.com/smallyunet/defi-invariant-lab/
git switch v0.0.1
cd defi-invariant-lab
</code></pre>
<h3 id="部署代币合约"><a href="#部署代币合约" class="headerlink" title="部署代币合约"></a>部署代币合约</h3><h4 id="部署合约"><a href="#部署合约" class="headerlink" title="部署合约"></a>部署合约</h4><p>部署两个测试版本的 ERC-20 代币，一个叫 USDC，一个叫 WETH：</p>
<pre><code class="bash">forge create \
  --rpc-url $RPC_URL \
  --private-key $PK_HEX \
  --broadcast \
  contracts/libs/TestERC20.sol:TestERC20 \
  --constructor-args &quot;USD Coin&quot; &quot;USDC6&quot; 6
</code></pre>
<p>部署的合约地址是：<a href="https://sepolia.etherscan.io/address/0x84637EaB3d14d481E7242D124e5567B72213D7F2"><code>0x84637EaB3d14d481E7242D124e5567B72213D7F2</code></a>。</p>
<pre><code class="bash">forge create \
  --rpc-url $RPC_URL \
  --private-key $PK_HEX \
  --broadcast \
  contracts/libs/TestERC20.sol:TestERC20 \
  --constructor-args &quot;Wrapped Ether&quot; &quot;WETH18&quot; 18
</code></pre>
<p>部署的合约地址是：<a href="https://sepolia.etherscan.io/address/0xD1d071cBfce9532C1D3c372f3962001A8aa332b7"><code>0xD1d071cBfce9532C1D3c372f3962001A8aa332b7</code></a>。</p>
<h4 id="验证合约"><a href="#验证合约" class="headerlink" title="验证合约"></a>验证合约</h4><p>如果愿意，可以这样验证下合约：</p>
<pre><code class="bash">export ETHERSCAN_API_KEY=你的key

cast abi-encode &quot;constructor(string,string,uint8)&quot; &quot;USD Coin&quot; &quot;USDC6&quot; 6

forge verify-contract \
  --chain-id 11155111 \
  0x84637EaB3d14d481E7242D124e5567B72213D7F2 \
  contracts/libs/TestERC20.sol:TestERC20 \
  --constructor-args &quot;0x000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000855534420436f696e00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000055553444336000000000000000000000000000000000000000000000000000000&quot; \
  --etherscan-api-key $ETHERSCAN_API_KEY

forge verify-contract \
  --chain-id 11155111 \
  0xD1d071cBfce9532C1D3c372f3962001A8aa332b7 \
  contracts/libs/TestERC20.sol:TestERC20 \
  --constructor-args $(cast abi-encode &quot;constructor(string,string,uint8)&quot; &quot;Wrapped Ether&quot; &quot;WETH18&quot; 18) \
  --etherscan-api-key $ETHERSCAN_API_KEY
</code></pre>
<h3 id="部署-AMM-合约"><a href="#部署-AMM-合约" class="headerlink" title="部署 AMM 合约"></a>部署 AMM 合约</h3><h4 id="部署合约-1"><a href="#部署合约-1" class="headerlink" title="部署合约"></a>部署合约</h4><p>这里的参数 30 指收取 0.3% 的手续费：</p>
<pre><code class="bash">forge create \
  --rpc-url $RPC_URL \
  --private-key $PK_HEX \
  --broadcast \
  contracts/amm/SimpleAMM.sol:SimpleAMM \
  --constructor-args $USDC_ADDR $WETH_ADDR 30
</code></pre>
<p>部署的合约地址是：<a href="https://sepolia.etherscan.io/address/0x339278aA7A09657A4674093Ab6A1A3df346EcFCF"><code>0x339278aA7A09657A4674093Ab6A1A3df346EcFCF</code></a>&#96;</p>
<h4 id="验证合约-1"><a href="#验证合约-1" class="headerlink" title="验证合约"></a>验证合约</h4><pre><code class="bash">forge verify-contract \
  --chain-id 11155111 \
  0x339278aA7A09657A4674093Ab6A1A3df346EcFCF \
  contracts/amm/SimpleAMM.sol:SimpleAMM \
  --constructor-args $(cast abi-encode &quot;constructor(address,address,uint16)&quot; $USDC_ADDR $WETH_ADDR 30) \
  --etherscan-api-key $ETHERSCAN_API_KEY
</code></pre>
<h3 id="mint-代币"><a href="#mint-代币" class="headerlink" title="mint 代币"></a>mint 代币</h3><p>声明钱包地址与合约地址：</p>
<pre><code class="bash">export MY_ADDR=0x44D7A0F44e6340E666ddaE70dF6eEa9b5b17a657
export AMM_ADDR=0x339278aA7A09657A4674093Ab6A1A3df346EcFCF
export USDC_ADDR=0x84637EaB3d14d481E7242D124e5567B72213D7F2
export WETH_ADDR=0xD1d071cBfce9532C1D3c372f3962001A8aa332b7
</code></pre>
<p>挖 100 万个 USDC，精度是 6 位数：</p>
<pre><code class="bash">cast send $USDC_ADDR &quot;mint(address,uint256)&quot; $MY_ADDR 1000000000000 \
  --rpc-url $RPC_URL --private-key $PK_HEX
</code></pre>
<p>挖 1000 个 WETH，精度是 18 位数：</p>
<pre><code class="bash">cast send $WETH_ADDR &quot;mint(address,uint256)&quot; $MY_ADDR 1000000000000000000000 \
  --rpc-url $RPC_URL --private-key $PK_HEX
</code></pre>
<p>铸币的交易与结果可以直接在浏览器上看到，<a href="https://sepolia.etherscan.io/tx/0x7140377c3c495be8a593a97c63cfa768783923861e539d330e49f9a93a2cfacd">这个</a> 是挖 USDC 的交易，<a href="https://sepolia.etherscan.io/tx/0xeb659015a41982a3daaca481869ef4e6afc6c5b0b7a34fa656efc7bc2f9be6ad">这个</a> 是挖 WETH 的交易。</p>
<h3 id="给-AMM-合约授权"><a href="#给-AMM-合约授权" class="headerlink" title="给 AMM 合约授权"></a>给 AMM 合约授权</h3><p>给 AMM 授权是因为接下来想要给 AMM 添加流动性，添加流动性会调用 <a href="https://github.com/smallyunet/defi-invariant-lab/blob/v0.0.1/contracts/amm/SimpleAMM.sol#L29"><code>addLiquidity</code></a> 函数，其中用到了 <code>transferFrom</code>，所以需要先给合约授权，让合约可以动用我的 USDC 和 WETH 代币：</p>
<pre><code class="bash">cast send $USDC_ADDR &quot;approve(address,uint256)&quot; $AMM_ADDR &quot;0xffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff&quot; \
  --rpc-url $RPC_URL --private-key $PK_HEX

cast send $WETH_ADDR &quot;approve(address,uint256)&quot; $AMM_ADDR &quot;0xffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff&quot; \
  --rpc-url $RPC_URL --private-key $PK_HEX
</code></pre>
<p>交易哈希分别是 <a href="https://sepolia.etherscan.io/tx/0x5d71669f6a5a63f439a53e6af801d21fdf23ae67cf43d17e30d34b5f66974354">USDC</a> 和 <a href="https://sepolia.etherscan.io/tx/0x1650337af02c74280b9ae1b83222a35f77e090500e3099f419cb0dc0ec7062ab">WETH</a>。</p>
<h3 id="添加初始流动性"><a href="#添加初始流动性" class="headerlink" title="添加初始流动性"></a>添加初始流动性</h3><p>添加流动性的 <a href="https://github.com/smallyunet/defi-invariant-lab/blob/v0.0.1/contracts/amm/SimpleAMM.sol#L29">函数</a> 比较简单，大概是合约里有两个变量 <code>reserve0</code> 和 <code>reserve1</code>，调用 <code>addLiquidity</code> 函数的时候，会向 AMM 合约转账参数数量个代币。</p>
<p>先以 2000 USDC &#x2F; 1 WETH 的价格，添加初始流动性：</p>
<pre><code class="bash">cast send $AMM_ADDR &quot;addLiquidity(uint256,uint256)&quot; 200000000000 100000000000000000000 \
  --rpc-url $RPC_URL --private-key $PK_HEX
</code></pre>
<p><a href="https://sepolia.etherscan.io/tx/0x060bfff6111946c7c84fe6415f883c92ffe7ff9bd694e5b87598a647b63c089f">交易</a> 完成后，可以查询到 AMM 合约剩余的代币数量：</p>
<pre><code class="bash">cast call $AMM_ADDR &quot;getReserves()(uint112,uint112)&quot; --rpc-url $RPC_URL

# 200000000000 [2e11]
# 100000000000000000000 [1e20]
</code></pre>
<h3 id="用-USDC-换-WETH"><a href="#用-USDC-换-WETH" class="headerlink" title="用 USDC 换 WETH"></a>用 USDC 换 WETH</h3><h4 id="合约代码解读"><a href="#合约代码解读" class="headerlink" title="合约代码解读"></a>合约代码解读</h4><p>我们的合约代码 <a href="https://github.com/smallyunet/defi-invariant-lab/blob/v0.0.1/contracts/amm/SimpleAMM.sol#L39"><code>swap0For1</code></a> 是这样：</p>
<pre><code class="solidity">function swap0For1(uint256 amtIn) external returns (uint256 out) &#123;
    require(token0.transferFrom(msg.sender, address(this), amtIn), &quot;t0in&quot;); // 把用户的 x 转进合约
    uint256 r0 = token0.balanceOf(address(this)); // 查询当前 x
    uint256 r1 = token1.balanceOf(address(this)); // 查询当前 y

    uint256 amtInEff = (amtIn * (10_000 - feeBps)) / 10_000; //计算扣除手续费后，用户转入了多少 x
    // x*y=k, solve out = r1 - k/(r0)
    uint256 k = (r0 - amtInEff) * r1;   // 计算 k
    out = r1 - Math.ceilDiv(k, r0);     // 计算给用户多少 y
    require(token1.transfer(msg.sender, out), &quot;t1out&quot;);
&#125;
</code></pre>
<p>函数代码体现了刚才描述的关于 <code>x*y=k</code> 的恒定公式。因为 AMM 合约考虑到收手续费的问题，所以有一个 <code>amtInEff</code> 用来表示用户实际转入了多少 x。</p>
<h4 id="测试第-1-次交换"><a href="#测试第-1-次交换" class="headerlink" title="测试第 1 次交换"></a>测试第 1 次交换</h4><p>我们来实际发起交易，看看合约运行后的效果，先试着用 1000 USDC，看能换多少个 WETH 出来：</p>
<pre><code class="bash">cast send $AMM_ADDR &quot;swap0For1(uint256)&quot; 1000000000 \
  --rpc-url $RPC_URL --private-key $PK_HEX
</code></pre>
<p><a href="https://sepolia.etherscan.io/tx/0xf13bd1d1602d7c106c2acdf4cb3b1ec37fa42d8871a682e32cce3f2049fff5a2">交易</a> 完成后，查看一下代币余额：</p>
<pre><code class="bash">cast call $USDC_ADDR &quot;balanceOf(address)(uint256)&quot; $MY_ADDR --rpc-url $RPC_URL
cast call $WETH_ADDR &quot;balanceOf(address)(uint256)&quot; $MY_ADDR --rpc-url $RPC_URL

cast call $AMM_ADDR &quot;getReserves()(uint112,uint112)&quot; --rpc-url $RPC_URL
</code></pre>
<p>其实区块链浏览器上能很直接的看到交换的数量，交易哈希是：<a href="https://sepolia.etherscan.io/tx/0xf13bd1d1602d7c106c2acdf4cb3b1ec37fa42d8871a682e32cce3f2049fff5a2"><code>0xf13bd1d1602d7c106c2acdf4cb3b1ec37fa42d8871a682e32cce3f2049fff5a2</code></a> </p>
<p>我们转出了 1000 USDC，收到了 <code>0.496019900497512437</code> 个 WETH。这里因为有 0.3% 的手续费，所以收到的 WETH 不是 0.5。</p>
<p>除了手续费，还存在一个价格的问题，按理来说，随着剩余 WETH 数量的减少，WETH 的价格会越来越高。</p>
<h4 id="测试第-2-次交换"><a href="#测试第-2-次交换" class="headerlink" title="测试第 2 次交换"></a>测试第 2 次交换</h4><p>再来用 1000 USDC 兑换一次，看能换出多少 WETH：</p>
<pre><code class="bash">cast send $AMM_ADDR &quot;swap0For1(uint256)&quot; 1000000000 \
  --rpc-url $RPC_URL --private-key $PK_HEX
</code></pre>
<p>这次兑换的交易哈希是：<a href="https://sepolia.etherscan.io/tx/0x1ee9ceb0707d77d78669bfb6cc1179bf9d6b31c57b868f5f52ed2f01a4127481"><code>0x1ee9ceb0707d77d78669bfb6cc1179bf9d6b31c57b868f5f52ed2f01a4127481</code></a></p>
<p>这一次，花费了 1000 USDC，收到了 <code>0.491116179005960297</code> 个 WETH。与上一次兑换的结果相比，收到的 WETH 真的减少了。</p>
<h3 id="用-WETH-换-USDC"><a href="#用-WETH-换-USDC" class="headerlink" title="用 WETH 换 USDC"></a>用 WETH 换 USDC</h3><p>可以自己测试玩一下。</p>
</div></div></body><script src="/js/highlight.min.js"></script><script src="/js/main.js"></script><script src="/js/bootstrap/bootstrap.min.js"></script><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-Y7C0CVX9PK"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-Y7C0CVX9PK');</script></html>
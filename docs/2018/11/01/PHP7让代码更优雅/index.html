<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=0.5"><link rel="stylesheet" href="/css/post.css"><link rel="icon" href="/img/favicon.png"><title>PHP 7，让代码更优雅（译）</title><script src="/js/baidu_analytics.js"></script></head><body>　　<div class="inner"><h2>PHP 7，让代码更优雅（译）</h2><p>PHP 7已发布很久，它可以让代码更加简洁，让我们一睹其风采。</p>
<h3 id="标量类型声明"><a href="#标量类型声明" class="headerlink" title="标量类型声明"></a>标量类型声明</h3><p>标量指string、int、float和bool。PHP 7之前，如果要验证一个函数的参数类型，需要手动检测并抛出异常：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">add</span><span class="params">($num1, $num2)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!is_int($num1)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="keyword">Exception</span>(<span class="string">"$num1 is not an integer"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!is_int($num2)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="keyword">Exception</span>(<span class="string">"$num2 is not an integer"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ($num1 + $num2);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> add(<span class="number">2</span>, <span class="number">4</span>);     <span class="comment">// 6</span></span><br><span class="line"><span class="keyword">echo</span> add(<span class="number">1.5</span>, <span class="number">4</span>);   <span class="comment">// Fatal error: Uncaught Exception</span></span><br></pre></td></tr></table></figure>
<p>现在，可以直接声明参数类型：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">add</span><span class="params">(int $num1, int $num2)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> ($num1 + $num2);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> add(<span class="number">2</span>, <span class="number">4</span>);     <span class="comment">// 6</span></span><br><span class="line"><span class="keyword">echo</span> add(<span class="string">"2"</span>, <span class="number">4</span>);   <span class="comment">// 6</span></span><br><span class="line"><span class="keyword">echo</span> add(<span class="string">"sonething"</span>, <span class="number">4</span>);   <span class="comment">// Fatal error: Uncaught TypeError</span></span><br></pre></td></tr></table></figure>
<p>由于PHP默认运行在coercive模式，所以”2”被成功解析为2。可以使用declare函数启用严格模式：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">declare</span>(strict_types=<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">add</span><span class="params">(int $num1, int $num2)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> ($num1 + $num2);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> add(<span class="number">2</span>, <span class="number">4</span>);     <span class="comment">// 6</span></span><br><span class="line"><span class="keyword">echo</span> add(<span class="string">"2"</span>, <span class="number">4</span>);   <span class="comment">// Fatal error: Uncaught TypeError</span></span><br></pre></td></tr></table></figure>
<h3 id="返回类型声明"><a href="#返回类型声明" class="headerlink" title="返回类型声明"></a>返回类型声明</h3><p>像参数一样，现在返回值也可以指定类型：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">add</span><span class="params">($num1, $num2)</span>:<span class="title">int</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> ($num1 + $num2);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> add(<span class="number">2</span>, <span class="number">4</span>);     <span class="comment">// 6</span></span><br><span class="line"><span class="keyword">echo</span> add(<span class="number">2.5</span>, <span class="number">4</span>);   <span class="comment">// 6</span></span><br></pre></td></tr></table></figure>
<p>2.5 + 4返回了int类型的6，这是隐式类型转换。如果要避免隐式转换，可以使用严格模式来抛出异常：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">declare</span>(strict_types=<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">add</span><span class="params">($num1, $num2)</span>:<span class="title">int</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> ($num1 + $num2);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> add(<span class="number">2</span>, <span class="number">4</span>); <span class="comment">//6</span></span><br><span class="line"><span class="keyword">echo</span> add(<span class="number">2.5</span>, <span class="number">4</span>); <span class="comment">//Fatal error: Uncaught TypeError</span></span><br></pre></td></tr></table></figure>
<h3 id="空合并运算符"><a href="#空合并运算符" class="headerlink" title="空合并运算符"></a>空合并运算符</h3><p>在PHP5中，检测一个变量，如果未定义则为其赋初值，实现起来需要冗长的代码：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$username = <span class="keyword">isset</span>($_GET[<span class="string">'username]'</span>) ? $_GET[<span class="string">'username'</span>] : <span class="string">''</span>;</span><br></pre></td></tr></table></figure>
<p>在PHP 7中，可以使用新增的”??”运算符：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$username = $_GET[<span class="string">'username'</span>] ?? <span class="string">''</span>;</span><br></pre></td></tr></table></figure>
<p>这虽然仅仅是一个语法糖，但能让我们的代码简洁不少。</p>
<h3 id="太空船运算符"><a href="#太空船运算符" class="headerlink" title="太空船运算符"></a>太空船运算符</h3><p>也叫组合运算符，用于比较两表达式的大小。当$a小于、等于、大于$b时，分别返回-1、0、1。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">echo</span> <span class="number">1</span> &lt;=&gt; <span class="number">1</span>;   <span class="comment">// 0</span></span><br><span class="line"><span class="keyword">echo</span> <span class="number">1</span> &lt;=&gt; <span class="number">2</span>;   <span class="comment">// -1</span></span><br><span class="line"><span class="keyword">echo</span> <span class="number">2</span> &lt;=&gt; <span class="number">1</span>;   <span class="comment">// 1</span></span><br></pre></td></tr></table></figure>
<h3 id="批量导入声明"><a href="#批量导入声明" class="headerlink" title="批量导入声明"></a>批量导入声明</h3><p>在相同命名空间下的类、函数、常量，现在可以使用一个use表达式一次导入：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// PHP 7之前</span></span><br><span class="line"><span class="keyword">use</span> <span class="title">net</span>\<span class="title">smallyu</span>\<span class="title">ClassA</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">net</span>\<span class="title">smallyu</span>\<span class="title">ClassB</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">net</span>\<span class="title">smallyu</span>\<span class="title">ClassC</span> <span class="title">as</span> <span class="title">C</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">function</span> <span class="title">net</span>\<span class="title">smallyu</span>\<span class="title">funA</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">function</span> <span class="title">net</span>\<span class="title">smallyu</span>\<span class="title">funB</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">function</span> <span class="title">net</span>\<span class="title">smallyu</span>\<span class="title">funC</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">const</span> <span class="title">net</span>\<span class="title">smallyu</span>\<span class="title">ConstA</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">const</span> <span class="title">net</span>\<span class="title">smallyu</span>\<span class="title">ConstB</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">const</span> <span class="title">net</span>\<span class="title">smallyu</span>\<span class="title">ConstC</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// PHP 7</span></span><br><span class="line"><span class="keyword">use</span> <span class="title">net</span>\<span class="title">smallyu</span>\&#123;<span class="title">ClassA</span>, <span class="title">ClassB</span>, <span class="title">ClassC</span>&#125;;</span><br><span class="line"><span class="keyword">use</span> <span class="title">function</span> <span class="title">net</span>\<span class="title">smallyu</span>\&#123;<span class="title">funA</span>, <span class="title">funB</span>, <span class="title">funC</span>&#125;;</span><br><span class="line"><span class="keyword">use</span> <span class="title">const</span> <span class="title">net</span>\<span class="title">smallyu</span>\&#123;<span class="title">ConstA</span>, <span class="title">ConstB</span>, <span class="title">ConstC</span>&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="生成器相关特性"><a href="#生成器相关特性" class="headerlink" title="生成器相关特性"></a>生成器相关特性</h3><p>PHP中Generator函数和普通函数的形式相同。生成器使用在foreach的迭代中，比数组占用内存更少，效率更高。这是一个生成器的例子：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// 返回一个生成器</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getValues</span><span class="params">($max)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> ($i = <span class="number">0</span>; $i &lt; $max; $i++) &#123;</span><br><span class="line">        <span class="keyword">yield</span> $i * <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用生成器</span></span><br><span class="line"><span class="keyword">foreach</span>(getValues(<span class="number">99999</span>) <span class="keyword">as</span> $value) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"Values: $value \n"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>代码中出现了yield表达式，它就像return一样，在函数中返回一个值，每次只执行一次，并且会从上一次停止的位置开始执行。</p>
<p>PHP 7之前不允许生成器函数使用return返回值，现在允许了，return不会影响yield的正常迭代，return的值也可以使用$gen-&gt;getReturn()来获取：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$gen = (<span class="function"><span class="keyword">function</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">yield</span> <span class="string">"First Yield"</span>;</span><br><span class="line">    <span class="keyword">yield</span> <span class="string">"Second Yield"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="string">"return Value"</span>;</span><br><span class="line">&#125;)();</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span> ($gen <span class="keyword">as</span> $val) &#123;</span><br><span class="line">    <span class="keyword">echo</span> $val, PHP_EOL;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> $gen-&gt;getReturn();</span><br></pre></td></tr></table></figure>
<p>PHP 7还支持生成器委派，可以在一个生成器函数中调用另一个生成器：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">gen</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">yield</span> <span class="string">"yield 1 from gen1"</span>;</span><br><span class="line">    <span class="keyword">yield</span> <span class="string">"yield 2 from gen1"</span>;</span><br><span class="line">    <span class="keyword">yield</span> from gen2();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">gen2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">yield</span> <span class="string">"yield 3 from gen2"</span>;</span><br><span class="line">    <span class="keyword">yield</span> <span class="string">"yield 4 from gen2"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span> (gen() <span class="keyword">as</span> $val) &#123;</span><br><span class="line">    <span class="keyword">echo</span> $val, PHP_EOL;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="匿名类"><a href="#匿名类" class="headerlink" title="匿名类"></a>匿名类</h3><p>PHP 7也有匿名类啦。</p>
<h3 id="闭包"><a href="#闭包" class="headerlink" title="闭包"></a>闭包</h3><p>PHP 7对闭包的支持更加友好：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span> </span>&#123; <span class="keyword">private</span> $x = <span class="number">1</span>; &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// PHP 7之前</span></span><br><span class="line">$getAFun = <span class="function"><span class="keyword">function</span><span class="params">()</span> </span>&#123;<span class="keyword">return</span> <span class="keyword">$this</span>-&gt;x;&#125;;</span><br><span class="line">$getA = $getAFun-&gt;bindTo(<span class="keyword">new</span> A, <span class="string">'A'</span>); <span class="comment">// 中间层闭包</span></span><br><span class="line"><span class="keyword">echo</span> $getA();</span><br><span class="line"></span><br><span class="line"><span class="comment">// PHP 7之后</span></span><br><span class="line">$getA = <span class="function"><span class="keyword">function</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;x; &#125;;</span><br><span class="line"><span class="keyword">echo</span> $getA-&gt;call(<span class="keyword">new</span> A);</span><br></pre></td></tr></table></figure>
<h3 id="可为空类型"><a href="#可为空类型" class="headerlink" title="可为空类型"></a>可为空类型</h3><p>Nullable types是PHP 7.1的新特性之一，在参数类型声明前加上一个问号，约定该参数只能是指定类型或者NULL。可以用在返回类型上：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">testReturn</span><span class="params">()</span>: ?<span class="title">string</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'testing'</span>;</span><br><span class="line">&#125;</span><br><span class="line">var_dump(testReturn());     <span class="comment">// string(7) "testing"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">testReturn2</span><span class="params">()</span>: ?<span class="title">string</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line">var_dump(testReturn2());    <span class="comment">//NULL</span></span><br></pre></td></tr></table></figure>
<p>也可以用在参数类型上：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">test</span><span class="params">(?string $name)</span> </span>&#123;</span><br><span class="line">    var_dump($name);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">test(<span class="string">'testing'</span>);    <span class="comment">// string(7) "testing"</span></span><br><span class="line">test(<span class="keyword">null</span>);         <span class="comment">// NULL</span></span><br><span class="line">test();     <span class="comment">// Fatal error: Uncaught ArgumentCountError</span></span><br></pre></td></tr></table></figure>
<h3 id="数组解构"><a href="#数组解构" class="headerlink" title="数组解构"></a>数组解构</h3><p>list()函数的简化写法：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">$records = [</span><br><span class="line">    [<span class="number">1</span>, <span class="string">'smallyu'</span>],</span><br><span class="line">    [<span class="number">2</span>, <span class="string">'bigyu'</span>],</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="comment">// list() 风格</span></span><br><span class="line"><span class="keyword">list</span>($firstId, $firstName) = $records[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">// [] 风格，PHP 7.1</span></span><br><span class="line">[$firstId, $firstName] = $records[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">var_dump($firstId);     <span class="comment">// int(1)</span></span><br><span class="line">var_dump($firstName);   <span class="comment">// string(7) "smallyu"</span></span><br></pre></td></tr></table></figure>
<p>另一个新特性是list()和[]都支持keys了：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">$records = [</span><br><span class="line">    [<span class="string">"id"</span> =&gt; <span class="number">1</span>, <span class="string">"name"</span> =&gt; <span class="string">'smallyu'</span>],</span><br><span class="line">    [<span class="string">"id"</span> =&gt; <span class="number">2</span>, <span class="string">"name"</span> =&gt; <span class="string">'bigyu'</span>],</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="comment">// list() 风格</span></span><br><span class="line"><span class="keyword">list</span>(<span class="string">"id"</span> =&gt; $firstId, <span class="string">"name"</span> =&gt; $firstName) = $records[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">// [] 风格，PHP 7.1</span></span><br><span class="line">[<span class="string">"id"</span> =&gt; $firstId, <span class="string">"name"</span> =&gt; $firstName] = $records[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">var_dump($firstId);     <span class="comment">// int(1)</span></span><br><span class="line">var_dump($firstName);   <span class="comment">// string(7) "smallyu"</span></span><br></pre></td></tr></table></figure>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul>
<li><p>《Building REATful Web Services with PHP 7》 Chapter 2: PHP 7, To Code It Better</p>
</li>
<li><p><a href="http://php.net/manual/zh/migration70.new-features.php" target="_blank" rel="noopener">PHP: 新特性 - Manual</a></p>
</li>
</ul>
</div><script src="/js/jquery.min.js"></script><script src="/js/main.js"></script></body></html>
<!DOCTYPE html><html lang="zh-cn"><head><title>一个简单的对于Mysql的PDO操作类（PHP）</title><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=0.5"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="manifest" href="/site.webmanifest"><link rel="stylesheet" href="/css/highlight/xcode.min.css"><link rel="stylesheet" href="/css/bootstrap/bootstrap-tooltips.css"><link rel="stylesheet" href="/css/post.css"><script src="/js/jquery.min.js"></script><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="smallyu的博客（疯狂版）" type="application/atom+xml">
</head><body><script>if (/mobile/i.test(navigator.userAgent) || /android/i.test(navigator.userAgent)) {
  document.body.classList.add('mobile')
  var navbar = document.querySelector('nav.navbar');
  if (navbar) {
    navbar.classList.remove('navbar-fixed-top');
  }
}
</script><div><div class="inner"><h1>一个简单的对于Mysql的PDO操作类（PHP）</h1><div class="time">2017-03-03</div><ul class="tags"><li><span>#</span><a href="/tags/PDO/">PDO</a></li><li><span>#</span><a href="/tags/PHP/">PHP</a></li></ul><p>类结构本身稍微混乱，方法没有规章，这是缺点。  </p>
<blockquote>
<p>PDOMysql.class.php  </p>
</blockquote>
<pre><code class="php">&lt;?php

define(&quot;DB_HOST&quot;, &quot;localhost&quot;);
define(&quot;DB_USER&quot;, &#39;root&#39;);
define(&quot;DB_PWD&quot;, &#39;root&#39;);
define(&quot;DB_NAME&quot;, &#39;minyy&#39;);
define(&quot;DB_PORT&quot;, &#39;3306&#39;);
define(&quot;DB_TYPE&quot;, &#39;mysql&#39;);
define(&quot;DB_CHARSET&quot;, &#39;utf8&#39;);

class PDOMySQL&#123;

    public static $config = array();  // 设置连接参数 配置信息
    public static $link = null; // 保存连接标志符
    public static $pconnect = false;   // 是否开启长连接
    public static $dbVersion = null;    // 保存数据库版本
    public static $connected = false;   // 是否连接成功
    public static $PDOStatement = null; // 保存PDOStatement对象
    public static $queryStr = null; // 保存最后执行的操作
    public static $error = null;    // 报错错误信息
    public static $lastInsertId = 0;    // 保存上一步插入操作产生AUTO_INSREMENT
    public static $numRows = 0; // 上一步操作产生受影响的记录条数

    /**
     * 构造函数实现连接数据库
     * @param array $dbConfig 配置项参数
     */
    public function __construct($dbConfig = &#39;&#39;)&#123;
        if(!class_exists(&quot;PDO&quot;))&#123;
            self::throw_exception(&#39;不支持PDO，请先开启&#39;);
        &#125;
        if(!$dbConfig || !is_array($dbConfig))&#123;
            $dbConfig = array(
                &#39;hostname&#39; =&gt; DB_HOST,
                &#39;username&#39; =&gt; DB_USER,
                &#39;password&#39; =&gt; DB_PWD,
                &#39;database&#39; =&gt; DB_NAME,
                &#39;hostport&#39; =&gt; DB_PORT,
                &#39;dbms&#39; =&gt; DB_TYPE,
                &#39;dsn&#39; =&gt; DB_TYPE.&quot;:host=&quot;.DB_HOST.&quot;;dbname=&quot;.DB_NAME,
                );
        &#125;
        if(empty($dbConfig[&#39;hostname&#39;])) self::throw_exception(&#39;没有定义数据库配置&#39;);
        self::$config = $dbConfig;
        if(empty(self::$config[&#39;params&#39;])) self::$config[&#39;params&#39;] = array();
        if(!isset(self::$link))&#123;
            $configs = self::$config;
            if(self::$pconnect)&#123;
                // 开启长连接，添加到配置数组中
                $configs[&#39;params&#39;][constant(&quot;PDO::ATTR_PERSISTENT&quot;)] = true;
            &#125;
            try&#123;
                self::$link = new PDO($configs[&#39;dsn&#39;], $configs[&#39;username&#39;], $configs[&#39;password&#39;], $configs[&#39;params&#39;]);
            &#125;catch(PDOException $e)&#123;
                self::throw_exception($e-&gt;getMessage());
            &#125;
            if(!self::$link)&#123;
                self::throw_exception(&#39;PDO连接错误&#39;);
                return false;
            &#125;
            self::$link-&gt;exec(&#39;SET NAMES &#39;.DB_CHARSET);
            self::$dbVersion = self::$link-&gt;getAttribute(constant(&quot;PDO::ATTR_SERVER_VERSION&quot;));
            self::$connected = true;
            unset($configs);
        &#125;
    &#125;

    /**
     * 得到所有记录
     * @param  string $sql SQL语句
     * @return array      得到所有数据
     */
    public static function getAll($sql = null)&#123;
        if($sql)&#123;
            self::query($sql);
        &#125;
        $result = self::$PDOStatement-&gt;fetchAll(constant(&quot;PDO::FETCH_ASSOC&quot;));
        return $result;
    &#125;

    /**
     * 得到结果集中的一条记录
     * @param  string $sql sql语句
     * @return array      返回一条数据
     */
    public static function getRow($sql = null)&#123;
        if($sql != null)&#123;
            self::query($sql);
        &#125;
        $result = self::$PDOStatement-&gt;fetch(constant(&quot;PDO::FETCH_ASSOC&quot;));
        return $result;
    &#125;

    /**
     * 根据主键查找记录
     * @param  string $tabName 表名
     * @param  string $priId   主键id
     * @param  string $field   查询项
     * @return array          一条记录
     */
    public static function findById($tabName, $priId, $field=&#39;*&#39;)&#123;
        $sql = &quot;SELECT %s FROM %s WHERE id=%d&quot;;
        return self::getRow(sprintf($sql, self::parseField($field), $tabName, $priId));
    &#125;

    /**
     * 执行普通查询
     * @param  string $tables 查询表名
     * @param  string $where  where
     * @param  string $fields 要查询字段
     * @param  string $group  group by
     * @param  string $having having
     * @param  string $order  order
     * @param  string $limit  limit
     * @return array         [description]
     */
    public static function find($tables, $where = null, $fields = &#39;*&#39;, $group = null, $having = null, $order = null, $limit = null)&#123;
        $sql = &#39;SELECT &#39;.self::parseField($fields).&#39; FROM &#39;.$tables
            .self::parseWhere($where)
            .self::parseGroup($group)
            .self::parseHaving($having)
            .self::parseOrder($order)
            .self::parseLimit($limit);
        $dataAll = self::getAll($sql);

        return count($dataAll)==1 ? $dataAll[0] : $dataAll;
    &#125;

    /**
     * 添加记录的操作
     * @param array $data  要添加的内容
     * @param int $table 受影响的条数
     */
    public static function add($data, $table)&#123;
        $keys = array_keys($data);
        array_walk($keys,array(&#39;PDOMySQL&#39;,&#39;addSpecilChar&#39;));
        $fieldsStr=join(&#39;,&#39;,$keys);
        $values=&quot;&#39;&quot;.join(&quot;&#39;,&#39;&quot;,array_values($data)).&quot;&#39;&quot;;
        $sql = &quot;INSERT &#123;$table&#125;(&#123;$fieldsStr&#125;) VALUES(&#123;$values&#125;)&quot;;
        return self::execute($sql);
    &#125;

    /**
     * 更新记录
     * @param  array $data  要更新内容
     * @param  string $table 表名
     * @param  string $where 条件
     * @param  string $order 排序
     * @param  string $limit 限制
     * @return int       受影响条数
     */
    public static function update($data, $table, $where = null, $order = null, $limit = null)&#123;
        $sets = &#39;&#39;;
        foreach ($data as $key =&gt; $val) &#123;
            $sets .= $key.&quot;=&#39;&quot;.$val.&quot;&#39;,&quot;;
        &#125;
        $sets = rtrim($sets,&#39;,&#39;);
        $sql = &quot;UPDATE &#123;$table&#125; SET &#123;$sets&#125; &quot;.self::parseWhere($where).self::parseOrder($order).self::parseLimit($limit);
        return self::execute($sql);
    &#125;

    /**
     * 解析字段
     * @param  string $fields 字段
     * @return string         解析后的字段
     */
    public static function parseField($fields)&#123;
        if(is_array($fields))&#123;
            array_walk($fields, array(&#39;PDOMySQL&#39;, &#39;addSpecilChar&#39;));
            $fieldsStr = implode(&#39;,&#39;,$fields);
        &#125;elseif(is_string($fields) &amp;&amp; !empty($fields))&#123;
            if(strpos($fields, &#39;`&#39;) === false)&#123;
                $fields = explode(&#39;,&#39;, $fields);
                array_walk($fields, array(&#39;PDOMySQL&#39;, &#39;addSpecilChar&#39;));
                $fieldsStr = implode(&#39;,&#39;,$fields);
            &#125;else&#123;
                $fieldsStr = $fields;
            &#125;
        &#125;else&#123;
            $fieldsStr = &#39;*&#39;;
        &#125;
        return $fieldsStr;
    &#125;

    /**
     * 删除操作
     * @param  string  $table 表名
     * @param  string  $where 条件
     * @param  string  $order 排序
     * @param  integer $limit 限制
     * @return integer        受影响条数
     */
    public static function delete($table, $where=null, $order=null, $limit=0)&#123;
        $sql = &quot;DELETE FROM &#123;$table&#125; &quot;.self::parseWhere($where).self::parseOrder($order).self::parseLimit($limit);
        return self::execute($sql);
    &#125;

    /**
     * 得到最后执行的sql语句
     * @return string sql语句
     */
    public static function getLastSql()&#123;
        $link=self::$link;
        if(!$link) return false;
        return self::$queryStr;
    &#125;

    /**
     * 得到插入操作产生的AUTO_INCREMENT
     * @return int 被操作id
     */
    public static function getLastInsertId()&#123;
        $link=self::$link;
        if(!$link) return false;
        return self::$lastInsertId;
    &#125;

    /**
     * 得到数据库的版本
     * @return float 数据库版本
     */
    public static function getDbVersion()&#123;
        $link=self::$link;
        if(!$link) return false;
        return self::$dbVersion;
    &#125;

    /**
     * 得到数据库中的数据表
     * @return array 所有数据表
     */
    public static function showTbales()&#123;
        $tables = [];
        if(self::query(&quot;SHOW TABLES&quot;))&#123;
            $result = self::getAll();
            foreach ($result as $key =&gt; $value) &#123;
                $tables[$key]=current($value);
            &#125;
        &#125;
        return $tables;
    &#125;

    /**
     * 解析where字段
     * @param  string $where 字段
     * @return string        解析后的字段
     */
    public static function parseWhere($where)&#123;
        $whereStr = &#39;&#39;;
        if(is_string($where) &amp;&amp; !empty($where))&#123;
            $whereStr = $where;
        &#125;
        return empty($whereStr) ? &#39;&#39; : &#39; WHERE &#39;.$whereStr;
    &#125;

    /**
     * 解析分组字段group by
     * @param  string $group 字段
     * @return string        解析后的字段
     */
    public static function parseGroup($group)&#123;
        $groupStr = &#39;&#39;;
        if(is_array($group))&#123;
            $groupStr .= &#39; GROUP BY &#39;.implode(&#39;,&#39;, $group);
        &#125;elseif(is_string($group) &amp;&amp; !empty($group))&#123;
            $groupStr .= &#39; GROUP BY &#39;.$group;
        &#125;
        return empty($groupStr) ? &#39;&#39; : $groupStr;
    &#125;

    /**
     * 对分组进行二次筛选
     * @param  string $having 字段
     * @return string         解析后的字段
     */
    public static function parseHaving($having)&#123;
        $havingStr = &#39;&#39;;
        if(is_string($having) &amp;&amp; !empty($having))&#123;
            $havingStr = &#39; HAVING &#39;.$having;
        &#125;
        return $havingStr;
    &#125;

    /**
     * 解析order by
     * @param  string $order 字段
     * @return string        解析后的字段
     */
    public static function parseOrder($order)&#123;
        $orderStr = &#39;&#39;;
        if(is_array($order))&#123;
            $orderStr .= &#39; ORDER BY &#39;.join(&#39;,&#39;,$order);
        &#125;elseif(is_string($order) &amp;&amp; !empty($order))&#123;
            $orderStr .= &#39; ORDER BY &#39;.$order;
        &#125;
        return $orderStr;
    &#125;

    /**
     * 解析limit
     * @param  strign $limit 字段
     * @return strign        解析后的字段
     */
    public static function parseLimit($limit)&#123;
        $limitStr = &#39;&#39;;
        if(is_array($limit))&#123;
            if(count($limit) &gt; 1)&#123;
                $limitStr = &#39; LIMIT &#39;.$limit[0].&#39;,&#39;.$limit[1];
            &#125;else&#123;
                $limitStr = &#39; LIMIT &#39;.$limit[0];
            &#125;
        &#125;elseif(!empty($limit))&#123;
            $limitStr .= &#39; LIMIT &#39;.$limit;
        &#125;
        return $limitStr;
    &#125;

    /**
     * 通过反引号引用字段
     * @param string &amp;$value 不同类型字段
     */
    public static function addSpecilChar(&amp;$value)&#123;
        if($value === &#39;*&#39; || strpos($value, &#39;.&#39;) != false || strpos($value, &#39;`&#39;) != false)&#123;
            // 不做处理
        &#125;elseif(strpos($value, &#39;`&#39;) === false)&#123;
            $value = &#39;`&#39;.trim($value).&#39;`&#39;;
        &#125;
        return $value;
    &#125;

    /**
     * 执行增删改操作，返回受影响的记录条数
     * @param  string $sql sql语句
     * @return int      受影响条数
     */
    public static function execute($sql = null)&#123;
        $link = self::$link;
        if(!$link) return false;
        self::$queryStr = $sql;
        if(!empty(self::$PDOStatement)) self::free();
        $result = $link-&gt;exec(self::$queryStr);
        self::haveErrorThrowException();
        if($result)&#123;
            self::$lastInsertId = $link-&gt;lastInsertId();
            self::$numRows = $result;
            return self::$numRows;
        &#125;else&#123;
            return false;
        &#125;
    &#125;

    /**
     * 释放结果集
     * @return null null
     */
    public static function free()&#123;
        self::$PDOStatement = null;
    &#125;

    public static function query($sql = &#39;&#39;)&#123;
        $link = self::$link;
        if(!$link) return false;
        // 判断之前是否有结果集，如果有，释放结果集
        if(!empty(self::$PDOStatement)) self::free();
        self::$queryStr = $sql;
        self::$PDOStatement = $link-&gt;prepare(self::$queryStr);
        $res = self::$PDOStatement-&gt;execute();
        self::haveErrorThrowException();
        return $res;
    &#125;

    public static function haveErrorThrowException()&#123;
        $obj = empty(self::$PDOStatement) ? self::$link : self::$PDOStatement;
        $arrError = $obj-&gt;errorInfo();
        if($arrError[0] != &#39;00000&#39;)&#123;
            self::$error = &#39;SQLStatus: &#39;.$arrError[0].&#39;&lt;br /&gt;SQLError: &#39;.$arrError[2].&#39;&lt;br /&gt;Error SQL: &#39;.self::$queryStr;
            self::throw_exception(self::$error);
            return false;
        &#125;
        if(self::$queryStr == &#39;&#39;)&#123;
            self::throw_exception(&#39;没有执行的SQL语句&#39;);
            return false;
        &#125;
    &#125;

    /**
     * 自定义错误处理
     * @param  string $errMsg 错误信息
     * @return null         null
     */
    public static function throw_exception($errMsg)&#123;
        echo $errMsg;
    &#125;

    /**
     * 销毁连接对象，关闭数据库
     * @return null null
     */
    public static function close()&#123;
        self::$link = null;
    &#125;
&#125;
</code></pre>
<p>在场景中这样来使用，注释后的内容分别用来测试不同方法：</p>
<blockquote>
<p>index.php  </p>
</blockquote>
<pre><code class="php">&lt;?php

$PDOMySQL = new PDOMySQL();

// 查询全部记录
$sql = &#39;SELECT * FROM cheat_exam&#39;;
$res = $PDOMySQL-&gt;getAll($sql);

// 查询一条记录
$sql = &#39;SELECT * FROM cheat_exam WHERE id=1&#39;;
$res = $PDOMySQL-&gt;getRow($sql);

// 插入一条记录
$sql = &#39;INSERT cheat_exam(name) VALUES (1)&#39;;
$res = $PDOMySQL-&gt;execute($sql);
echo $PDOMySQL::$lastInsertId;

// 删除一条记录
$sql = &#39;DELETE FROM cheat_exam WHERE id=115&#39;;
$res = $PDOMySQL-&gt;execute($sql);

// 更新一条记录
$sql = &#39;UPDATE arr SET name=&quot;1&quot; WHERE id=1&#39;;
$res = $PDOMySQL-&gt;execute($sql);

// 根据主键查询一条记录
$tabName = &#39;cheat_exam&#39;;
$priId = 1;
$fields=&#39;subject,name&#39;;
$fields = array(&#39;subject&#39;,&#39;name&#39;);
$res = $PDOMySQL-&gt;findById($tabName, $priId, $fields);

// 执行普通查询
$tables = &#39;cheat_exam&#39;;
$res = $PDOMySQL-&gt;find($tables);
$res = $PDOMySQL-&gt;find($tables, &#39;id&gt;=30&#39;);
$res = $PDOMySQL-&gt;find($tables, &#39;id&gt;=30&#39;, &#39;subject,name&#39;);
$res = $PDOMySQL-&gt;find($tables, &#39;id&gt;=30&#39;, &#39;*&#39;, &#39;subject&#39;);
$res = $PDOMySQL-&gt;find($tables, &#39;id&gt;=30&#39;, &#39;*&#39;, &#39;subject&#39;, &#39;count(*)&gt;=8&#39;);
$res = $PDOMySQL-&gt;find($tables, &#39;id&gt;=30&#39;, &#39;*&#39;, &#39;&#39;, &#39;&#39;, &#39;id desc&#39;);
$res = $PDOMySQL-&gt;find($tables, &#39;id&gt;=30&#39;, &#39;*&#39;, &#39;&#39;, &#39;&#39;, &#39;id desc&#39;, 5);

// 更新一条记录
$data = [
    &#39;subject&#39; =&gt; &#39;imooc&#39;,
    &#39;name&#39; =&gt; &#39;name&#39;
    ];
$table = &quot;cheat_exam&quot;;
$res = $PDOMySQL-&gt;add($data, $table);
// 也是更新操作
$data = [
    &#39;subject&#39; =&gt; &#39;imooc&#39;,
    &#39;name&#39; =&gt; &#39;name&#39;
    ];
$table = &quot;cheat_exam&quot;;
$res = $PDOMySQL-&gt;update($data, $table, &#39;id&lt;=3&#39;, &#39;id desc&#39;, 5);

// 删除操作
$table = &quot;cheat_exam&quot;;
$res = $PDOMySQL-&gt;delete($table, &#39;id&lt;3&#39;);

// 得到数据表
$res = $PDOMySQL-&gt;showTbales();

print_r($res);
</code></pre>
<p>会打印出不同结果。  </p>
<p>The End.</p>
</div></div></body><script src="/js/highlight.min.js"></script><script src="/js/main.js"></script><script src="/js/bootstrap/bootstrap.min.js"></script><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-Y7C0CVX9PK"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-Y7C0CVX9PK');</script></html>